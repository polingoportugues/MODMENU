-- ESP SECRET Lucky Blocks com Linha Laser
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

local CONFIG = {
    MaxDistance = 1000,
    TextSize = 16,
    TextStrokeTransparency = 0.5,
    RarityName = "Secret",
    RarityColor = Color3.fromRGB(255, 255, 0),
    -- Configurações da linha laser
    LineEnabled = true,
    LineColor = Color3.fromRGB(255, 255, 0),
    LineThickness = 0.05,
    LineTransparency = 0.3,
}

local IGNORE_NAMES = {
    ["Floor"] = true, ["floor"] = true, ["Platform"] = true, ["platform"] = true,
    ["Ground"] = true, ["ground"] = true, ["FirstFloor"] = true, ["SecondFloor"] = true,
    ["ThirdFloor"] = true, ["Line"] = true, ["Teleport"] = true,
}

local billboards = {}
local lines = {}

local function isValidLuckyBlock(obj)
    local name = obj.Name
    for ignoreName, _ in pairs(IGNORE_NAMES) do
        if name:find(ignoreName) then return false end
    end
    if name:find("LuckyBlock") then return true end
    if obj:IsA("Model") or obj:IsA("Folder") then
        if obj:FindFirstChild("BlockCtrl") then return true end
    end
    if obj:IsA("BasePart") then
        local size = obj.Size
        if size.Y < 2 then return false end
        if (size.X > size.Y * 3) or (size.Z > size.Y * 3) then return false end
    end
    return true
end

local function createLine(part)
    if lines[part] then
        lines[part]:Destroy()
    end
    
    -- Criar pasta para organizar as linhas
    local linesFolder = workspace:FindFirstChild("ESP_Lines_Secret") or Instance.new("Folder", workspace)
    linesFolder.Name = "ESP_Lines_Secret"
    
    -- Criar a linha usando um Beam
    local attachment0 = Instance.new("Attachment")
    attachment0.Name = "LineStart"
    attachment0.Parent = Camera
    
    local attachment1 = Instance.new("Attachment")
    attachment1.Name = "LineEnd"
    attachment1.Parent = part
    
    local beam = Instance.new("Beam")
    beam.Name = "ESP_Line_Secret"
    beam.Attachment0 = attachment0
    beam.Attachment1 = attachment1
    beam.Color = ColorSequence.new(CONFIG.LineColor)
    beam.Width0 = CONFIG.LineThickness
    beam.Width1 = CONFIG.LineThickness
    beam.Transparency = NumberSequence.new(CONFIG.LineTransparency)
    beam.FaceCamera = true
    beam.LightEmission = 0.8
    beam.LightInfluence = 0
    beam.Segments = 1
    beam.Parent = linesFolder
    
    lines[part] = {
        beam = beam,
        attachment0 = attachment0,
        attachment1 = attachment1
    }
end

local function updateLine(part)
    if not CONFIG.LineEnabled then
        if lines[part] then
            lines[part].beam.Enabled = false
        end
        return
    end
    
    if not lines[part] or not part:IsDescendantOf(workspace) then return end
    
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return end
    
    local distance = (character.HumanoidRootPart.Position - part.Position).Magnitude
    
    if distance > CONFIG.MaxDistance then
        lines[part].beam.Enabled = false
    else
        lines[part].beam.Enabled = true
        
        -- Atualizar posição do attachment0 para o centro superior da tela
        local viewportSize = Camera.ViewportSize
        local screenCenter = Vector2.new(viewportSize.X / 2, 0)
        
        -- Converter posição da tela para posição 3D
        local ray = Camera:ViewportPointToRay(screenCenter.X, screenCenter.Y)
        local startPosition = ray.Origin + ray.Direction * 5
        
        lines[part].attachment0.WorldPosition = startPosition
        lines[part].attachment1.WorldPosition = part.Position
    end
end

local function createBillboard(part)
    if billboards[part] then billboards[part]:Destroy() end
    
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "ESP_Billboard"
    billboard.Adornee = part
    billboard.Size = UDim2.new(0, 200, 0, 50)
    billboard.StudsOffset = Vector3.new(0, 3, 0)
    billboard.AlwaysOnTop = true
    billboard.Parent = part
    
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Name = "NameLabel"
    nameLabel.Size = UDim2.new(1, 0, 0.5, 0)
    nameLabel.BackgroundTransparency = 1
    nameLabel.Text = CONFIG.RarityName
    nameLabel.TextColor3 = CONFIG.RarityColor
    nameLabel.TextSize = CONFIG.TextSize
    nameLabel.TextStrokeTransparency = CONFIG.TextStrokeTransparency
    nameLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    nameLabel.Font = Enum.Font.SourceSansBold
    nameLabel.Parent = billboard
    
    local distanceLabel = Instance.new("TextLabel")
    distanceLabel.Name = "DistanceLabel"
    distanceLabel.Size = UDim2.new(1, 0, 0.5, 0)
    distanceLabel.Position = UDim2.new(0, 0, 0.5, 0)
    distanceLabel.BackgroundTransparency = 1
    distanceLabel.Text = "0m"
    distanceLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    distanceLabel.TextSize = CONFIG.TextSize - 2
    distanceLabel.TextStrokeTransparency = CONFIG.TextStrokeTransparency
    distanceLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    distanceLabel.Font = Enum.Font.SourceSans
    distanceLabel.Parent = billboard
    
    billboards[part] = billboard
    
    -- Criar linha laser para este part
    if CONFIG.LineEnabled then
        createLine(part)
    end
end

local function updateDistance(part)
    if not billboards[part] or not part:IsDescendantOf(workspace) then return end
    
    local character = LocalPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return end
    
    local distance = (character.HumanoidRootPart.Position - part.Position).Magnitude
    
    if distance > CONFIG.MaxDistance then
        billboards[part].Enabled = false
    else
        billboards[part].Enabled = true
        local distanceLabel = billboards[part]:FindFirstChild("DistanceLabel")
        if distanceLabel then
            distanceLabel.Text = string.format("%.1fm", distance)
        end
    end
end

local function processLuckyBlock(block)
    if not isValidLuckyBlock(block) then return end
    local rootPart = block:FindFirstChild("RootPart")
    if rootPart and rootPart:IsA("BasePart") and block.Name:find(CONFIG.RarityName) then
        createBillboard(rootPart)
    end
end

local function processSpawner(spawner)
    if not isValidLuckyBlock(spawner) then return end
    if spawner:IsA("BasePart") then
        createBillboard(spawner)
    elseif spawner:IsA("Model") or spawner:IsA("Folder") then
        local mainPart = spawner:FindFirstChild("RootPart") or spawner:FindFirstChild("Part") or spawner:FindFirstChildWhichIsA("BasePart")
        if mainPart then createBillboard(mainPart) end
    end
end

local function scanSpawnersInContainer(container)
    if not container then return end
    for _, child in pairs(container:GetChildren()) do
        if not IGNORE_NAMES[child.Name] and child.Name == CONFIG.RarityName then
            processSpawner(child)
        end
    end
    container.ChildAdded:Connect(function(child)
        task.wait(0.1)
        if not IGNORE_NAMES[child.Name] and child.Name == CONFIG.RarityName then
            processSpawner(child)
        end
    end)
end

local function scanMap(map)
    local spawners = map:FindFirstChild("Spawners")
    if spawners then scanSpawnersInContainer(spawners) end
    
    local og = map:FindFirstChild("OG")
    if og then scanSpawnersInContainer(og) end
    
    local defaultStudioMap = map:FindFirstChild("DefaultStudioMap")
    if defaultStudioMap then
        local studioSpawners = defaultStudioMap:FindFirstChild("Spawners")
        if studioSpawners then scanSpawnersInContainer(studioSpawners) end
    end
    
    for _, child in pairs(map:GetDescendants()) do
        if child.Name == "Spawners" and child:IsA("Folder") then
            scanSpawnersInContainer(child)
        end
    end
end

local function scanAllMaps()
    for _, child in pairs(workspace:GetChildren()) do
        if child.Name:match("Map$") then scanMap(child) end
    end
    workspace.ChildAdded:Connect(function(child)
        task.wait(0.2)
        if child.Name:match("Map$") or child:FindFirstChild("Spawners") then
            scanMap(child)
        end
    end)
end

local function scanActiveLuckyBlocks()
    local activeLuckyBlocks = workspace:FindFirstChild("ActiveLuckyBlocks")
    if activeLuckyBlocks then
        for _, block in pairs(activeLuckyBlocks:GetChildren()) do
            processLuckyBlock(block)
        end
        activeLuckyBlocks.ChildAdded:Connect(function(block)
            task.wait(0.1)
            processLuckyBlock(block)
        end)
    end
end

-- Função para ligar/desligar linhas
function toggleLines(enabled)
    CONFIG.LineEnabled = enabled
    if not enabled then
        for part, lineData in pairs(lines) do
            lineData.beam.Enabled = false
        end
    end
end

-- Função para mudar cor das linhas
function setLineColor(color)
    CONFIG.LineColor = color
    for part, lineData in pairs(lines) do
        lineData.beam.Color = ColorSequence.new(color)
    end
end

print("ESP SECRET com Linha Laser ativado!")
scanActiveLuckyBlocks()
scanAllMaps()

RunService.RenderStepped:Connect(function()
    for part, billboard in pairs(billboards) do
        if part and part:IsDescendantOf(workspace) then
            updateDistance(part)
            updateLine(part)
        else
            billboard:Destroy()
            billboards[part] = nil
            
            -- Limpar linha também
            if lines[part] then
                lines[part].beam:Destroy()
                lines[part].attachment0:Destroy()
                lines[part].attachment1:Destroy()
                lines[part] = nil
            end
        end
    end
end)
