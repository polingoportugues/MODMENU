-- ESP Lucky Blocks Script - VERSÃƒO OTIMIZADA SEM LAG
-- by ANXIIE
-- Script hospedado no GitHub - Controlado pela GUI

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer

print("ðŸ” ESP: Iniciando script otimizado...")

-- ========================================
-- CONFIGURAÃ‡Ã•ES DE CORES POR RARIDADE
-- ========================================

local raridadeCores = {
    Celestial = Color3.fromRGB(255, 215, 0),     -- Dourado brilhante
    Legendary = Color3.fromRGB(255, 140, 0),     -- Laranja brilhante
    Secret = Color3.fromRGB(138, 43, 226),       -- Roxo
    Cosmic = Color3.fromRGB(147, 112, 219),      -- Roxo claro
    Mythical = Color3.fromRGB(255, 69, 0),       -- Vermelho alaranjado
    Epic = Color3.fromRGB(128, 0, 128),          -- Roxo escuro
    Rare = Color3.fromRGB(0, 112, 221),          -- Azul
    Uncommon = Color3.fromRGB(46, 125, 50),      -- Verde
    Common = Color3.fromRGB(158, 158, 158)       -- Cinza
}

-- Verificar se as variÃ¡veis globais existem
if not _G.espRaridades then
    _G.espRaridades = {
        Celestial = false,
        Legendary = false,
        Secret = false,
        Cosmic = false,
        Mythical = false,
        Epic = false,
        Rare = false,
        Uncommon = false,
        Common = false
    }
    print("âš ï¸ ESP: VariÃ¡veis globais criadas")
end

-- ========================================
-- FOLDER PARA ORGANIZAR ESP
-- ========================================

local folderESP = Instance.new("Folder")
folderESP.Name = "ESP_LuckyBlocks_ANXIIE"
folderESP.Parent = Workspace

-- ========================================
-- ARMAZENAMENTO DE CONEXÃ•ES ESP
-- ========================================

local espAtivos = {}

-- ========================================
-- FUNÃ‡ÃƒO PARA DETECTAR RARIDADE
-- ========================================

local function detectarRaridade(obj)
    if not obj then return nil end
    
    -- Criar uma string de busca com o nome do objeto e seus parentes
    local searchString = obj.Name
    
    -- Adicionar nome do parent
    if obj.Parent then
        searchString = searchString .. " " .. obj.Parent.Name
        
        -- Adicionar nome do parent do parent
        if obj.Parent.Parent then
            searchString = searchString .. " " .. obj.Parent.Parent.Name
        end
    end
    
    -- Buscar nos children tambÃ©m
    for _, child in ipairs(obj:GetChildren()) do
        searchString = searchString .. " " .. child.Name
        if child:IsA("TextLabel") and child.Text then
            searchString = searchString .. " " .. child.Text
        end
    end
    
    -- Converter para lowercase para busca case-insensitive
    searchString = searchString:lower()
    
    -- Verificar cada raridade
    for raridade, _ in pairs(raridadeCores) do
        if searchString:find(raridade:lower()) then
            return raridade
        end
    end
    
    return nil
end

-- ========================================
-- FUNÃ‡ÃƒO PARA CRIAR CONEXÃƒO ESP OTIMIZADA
-- ========================================

local function criarConexaoESP(target, raridade, index)
    local char = player.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then
        return
    end
    
    -- Usar Terrain como adornee (mais otimizado)
    local adorneeLine = Workspace:FindFirstChildOfClass("Terrain") or char:FindFirstChild("HumanoidRootPart")
    if not adorneeLine then return end
    
    -- Criar linha usando CylinderHandleAdornment (muito mais otimizado que Beam)
    local line = Instance.new("CylinderHandleAdornment")
    line.Name = "ESP_Line_" .. raridade .. "_" .. index
    line.AlwaysOnTop = true
    line.Color3 = raridadeCores[raridade]
    line.Radius = 0.15
    line.Transparency = 0.3
    line.Adornee = adorneeLine
    line.Parent = folderESP
    
    -- Criar BillboardGui para mostrar distÃ¢ncia e nome
    local bill = Instance.new("BillboardGui")
    bill.Name = "ESP_Billboard_" .. raridade .. "_" .. index
    bill.Adornee = target
    bill.Size = UDim2.new(0, 120, 0, 50)
    bill.AlwaysOnTop = true
    bill.Parent = folderESP
    
    local txt = Instance.new("TextLabel")
    txt.Size = UDim2.new(1, 0, 1, 0)
    txt.BackgroundTransparency = 1
    txt.TextColor3 = Color3.fromRGB(255, 255, 255)
    txt.Font = Enum.Font.GothamBold
    txt.TextSize = 14
    txt.TextStrokeTransparency = 0.5
    txt.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    txt.Parent = bill
    
    -- ConexÃ£o RenderStepped para atualizar linha
    local renderConn
    renderConn = RunService.RenderStepped:Connect(function()
        -- Verificar se ESP estÃ¡ ativo para essa raridade
        if _G.espRaridades[raridade] and target and target.Parent and char and char:FindFirstChild("HumanoidRootPart") then
            local p1 = char.HumanoidRootPart.Position
            local p2 = target.Position
            local mag = (p2 - p1).Magnitude
            
            -- Atualizar linha
            line.Height = mag
            line.CFrame = CFrame.lookAt(p1, p2) * CFrame.new(0, 0, -mag/2)
            
            -- Atualizar texto com distÃ¢ncia
            txt.Text = string.format("%s\n%dm", raridade, math.floor(mag))
        else
            -- Limpar quando desativado ou target removido
            if line then line:Destroy() end
            if bill then bill:Destroy() end
            renderConn:Disconnect()
            
            -- Remover da tabela de ativos
            local key = tostring(target)
            if espAtivos[key] then
                espAtivos[key] = nil
            end
        end
    end)
    
    return {
        line = line,
        billboard = bill,
        connection = renderConn,
        target = target,
        raridade = raridade
    }
end

-- ========================================
-- FUNÃ‡ÃƒO PARA ENCONTRAR LUCKY BLOCKS
-- ========================================

local function encontrarLuckyBlocks()
    local blocks = {}
    
    -- Buscar em diferentes locais comuns
    local locaisBusca = {
        Workspace,
        Workspace:FindFirstChild("Map"),
        Workspace:FindFirstChild("LuckyBlocks"),
        Workspace:FindFirstChild("Blocks"),
        Workspace:FindFirstChild("Items"),
        Workspace:FindFirstChild("Game")
    }
    
    for _, localBusca in ipairs(locaisBusca) do
        if localBusca then
            for _, obj in ipairs(localBusca:GetDescendants()) do
                -- Verificar se Ã© um lucky block (BasePart)
                if obj:IsA("BasePart") and (
                    obj.Name:find("Lucky") or 
                    obj.Name:find("Block") or
                    (obj.Parent and (obj.Parent.Name:find("Lucky") or obj.Parent.Name:find("Block")))
                ) then
                    local raridade = detectarRaridade(obj)
                    if raridade then
                        table.insert(blocks, {block = obj, raridade = raridade})
                    end
                end
            end
        end
    end
    
    return blocks
end

-- ========================================
-- FUNÃ‡ÃƒO PARA ATUALIZAR ESP
-- ========================================

local function atualizarESP()
    -- Verificar se o character existe
    if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then
        return
    end
    
    -- Encontrar todos os lucky blocks
    local luckyBlocks = encontrarLuckyBlocks()
    
    -- Limpar ESP de blocos que nÃ£o existem mais
    for key, espInfo in pairs(espAtivos) do
        local blockExists = false
        
        for _, blockInfo in ipairs(luckyBlocks) do
            if tostring(blockInfo.block) == key then
                blockExists = true
                break
            end
        end
        
        -- Se o bloco nÃ£o existe mais ou a raridade foi desativada, remover ESP
        if not blockExists or not _G.espRaridades[espInfo.raridade] then
            if espInfo.line then espInfo.line:Destroy() end
            if espInfo.billboard then espInfo.billboard:Destroy() end
            if espInfo.connection then espInfo.connection:Disconnect() end
            espAtivos[key] = nil
        end
    end
    
    -- Adicionar ESP para novos blocos
    local counter = {}
    for _, blockInfo in ipairs(luckyBlocks) do
        local key = tostring(blockInfo.block)
        local raridade = blockInfo.raridade
        
        -- Contar blocos por raridade
        if not counter[raridade] then
            counter[raridade] = 0
        end
        counter[raridade] = counter[raridade] + 1
        
        -- Se a raridade estÃ¡ ativa e o bloco ainda nÃ£o tem ESP
        if _G.espRaridades[raridade] and not espAtivos[key] then
            local espInfo = criarConexaoESP(blockInfo.block, raridade, counter[raridade])
            if espInfo then
                espAtivos[key] = espInfo
            end
        end
    end
end

-- ========================================
-- CONEXÃƒO COM A GUI
-- ========================================

-- FunÃ§Ã£o para ativar ESP de uma raridade especÃ­fica
function _G.ativarESPLuckyBlockGitHub(raridade)
    print("ðŸŽ¯ ESP GitHub: Ativando ESP para " .. raridade)
    _G.espRaridades[raridade] = true
    atualizarESP()
end

-- FunÃ§Ã£o para desativar ESP de uma raridade especÃ­fica
function _G.desativarESPLuckyBlockGitHub(raridade)
    print("â¹ï¸ ESP GitHub: Desativando ESP para " .. raridade)
    _G.espRaridades[raridade] = false
    
    -- As conexÃµes vÃ£o se auto-destruir no prÃ³ximo frame do RenderStepped
end

-- ========================================
-- LOOP PRINCIPAL (OTIMIZADO)
-- ========================================

local ultimaAtualizacao = 0
local intervaloAtualizacao = 2 -- Atualizar a cada 2 segundos (otimizaÃ§Ã£o)

RunService.Heartbeat:Connect(function()
    local agora = tick()
    
    -- SÃ³ atualizar a lista de blocos a cada X segundos
    if agora - ultimaAtualizacao >= intervaloAtualizacao then
        atualizarESP()
        ultimaAtualizacao = agora
    end
end)

-- ========================================
-- INICIALIZAÃ‡ÃƒO
-- ========================================

print("âœ… ESP Lucky Blocks carregado (OTIMIZADO - SEM LAG)!")
print("ðŸŽ® Controlado pela GUI ANXIIE")
print("âš¡ Usando CylinderHandleAdornment para performance mÃ¡xima")

-- Primeira atualizaÃ§Ã£o
atualizarESP()

-- Limpar ao morrer e reiniciar ao respawnar
player.CharacterAdded:Connect(function(character)
    -- Limpar todas as conexÃµes antigas
    for key, espInfo in pairs(espAtivos) do
        if espInfo.line then espInfo.line:Destroy() end
        if espInfo.billboard then espInfo.billboard:Destroy() end
        if espInfo.connection then espInfo.connection:Disconnect() end
    end
    espAtivos = {}
    
    -- Limpar folder
    folderESP:ClearAllChildren()
    
    -- Aguardar character carregar
    character:WaitForChild("HumanoidRootPart")
    task.wait(1)
    
    -- Atualizar ESP
    atualizarESP()
end)
