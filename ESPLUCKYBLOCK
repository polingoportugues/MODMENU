-- ========================================
-- ESP LUCKY BLOCKS - GITHUB SCRIPT
-- Comunica√ß√£o com GUI via vari√°veis globais
-- ========================================

print("üîÑ Carregando ESP Lucky Blocks do GitHub...")

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer

-- ========================================
-- CONFIGURA√á√ïES E VARI√ÅVEIS GLOBAIS
-- ========================================

-- Tabela de raridades com cores ESPEC√çFICAS
local rarityColors = {
    Divine = Color3.fromRGB(255, 255, 255),      -- Branco
    Celestial = Color3.fromRGB(0, 255, 0),       -- Verde
    Legendary = Color3.fromRGB(255, 255, 0),     -- Amarelo
    Secret = Color3.fromRGB(255, 0, 255),        -- Magenta/Rosa
    Cosmic = Color3.fromRGB(138, 43, 226),       -- Roxo Escuro
    Mythical = Color3.fromRGB(255, 140, 0),      -- Laranja
    Epic = Color3.fromRGB(138, 43, 226),         -- Roxo
    Rare = Color3.fromRGB(0, 112, 221),          -- Azul
    Uncommon = Color3.fromRGB(0, 255, 0),        -- Verde Claro
    Common = Color3.fromRGB(200, 200, 200)       -- Cinza
}

-- Tabela para armazenar ESPs criados (cada bloco tem seu pr√≥prio ESP)
local activeESPs = {}

-- Conex√£o do loop principal
local espConnection = nil

-- ========================================
-- FUN√á√ïES DE DETEC√á√ÉO
-- ========================================

-- Fun√ß√£o para verificar se √© um Lucky Block colecion√°vel
local function isCollectibleBlock(part)
    if not part or not part:IsA("BasePart") then return false end
    
    -- Verificar se tem BillboardGui (indicador de raridade)
    local hasBillboard = part:FindFirstChildOfClass("BillboardGui")
    
    -- Verificar se n√£o √© parte do terreno (blocos grandes)
    local isNotTerrain = part.Size.X < 50 and part.Size.Y < 50 and part.Size.Z < 50
    
    -- Verificar se n√£o √© o ch√£o ou paredes
    local isNotGround = part.Name ~= "Ground" and 
                       part.Name ~= "Floor" and 
                       part.Name ~= "Baseplate" and
                       part.Name ~= "Wall" and
                       not part.Name:find("Wall") and
                       not part.Name:find("Floor")
    
    return hasBillboard and isNotTerrain and isNotGround
end

-- Fun√ß√£o para detectar raridade do bloco
local function getRarity(part)
    local billboard = part:FindFirstChildOfClass("BillboardGui")
    if billboard then
        local textLabel = billboard:FindFirstChildOfClass("TextLabel")
        if textLabel then
            local text = textLabel.Text
            
            -- Procurar por cada raridade no texto
            for rarity, _ in pairs(rarityColors) do
                if string.find(text:lower(), rarity:lower()) then
                    return rarity
                end
            end
        end
    end
    return nil
end

-- ========================================
-- FUN√á√ïES DE CRIA√á√ÉO DE ESP
-- ========================================

-- Fun√ß√£o para criar ESP INDIVIDUAL para cada bloco
local function createESP(part, rarity)
    -- Se j√° existe ESP neste part, n√£o criar outro
    if part:FindFirstChild("ESP_Highlight") then 
        return 
    end
    
    -- Criar Highlight (contorno colorido)
    local highlight = Instance.new("Highlight")
    highlight.Name = "ESP_Highlight"
    highlight.Adornee = part
    highlight.FillColor = rarityColors[rarity]
    highlight.OutlineColor = rarityColors[rarity]
    highlight.FillTransparency = 0.5
    highlight.OutlineTransparency = 0
    highlight.Parent = part
    
    -- Criar BillboardGui para mostrar dist√¢ncia e nome
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "ESP_Distance"
    billboard.Size = UDim2.new(0, 150, 0, 60)
    billboard.StudsOffset = Vector3.new(0, 3, 0)
    billboard.AlwaysOnTop = true
    billboard.Parent = part
    
    -- Texto com nome da raridade
    local nameLabel = Instance.new("TextLabel")
    nameLabel.Name = "NameLabel"
    nameLabel.Size = UDim2.new(1, 0, 0.5, 0)
    nameLabel.Position = UDim2.new(0, 0, 0, 0)
    nameLabel.BackgroundTransparency = 1
    nameLabel.TextColor3 = rarityColors[rarity]
    nameLabel.TextStrokeTransparency = 0
    nameLabel.TextScaled = true
    nameLabel.Font = Enum.Font.GothamBold
    nameLabel.Text = rarity
    nameLabel.Parent = billboard
    
    -- Texto com dist√¢ncia
    local distanceLabel = Instance.new("TextLabel")
    distanceLabel.Name = "DistanceLabel"
    distanceLabel.Size = UDim2.new(1, 0, 0.5, 0)
    distanceLabel.Position = UDim2.new(0, 0, 0.5, 0)
    distanceLabel.BackgroundTransparency = 1
    distanceLabel.TextColor3 = rarityColors[rarity]
    distanceLabel.TextStrokeTransparency = 0
    distanceLabel.TextScaled = true
    distanceLabel.Font = Enum.Font.Gotham
    distanceLabel.Parent = billboard
    
    -- Adicionar √† tabela de ESPs ativos
    table.insert(activeESPs, {
        part = part,
        rarity = rarity,
        highlight = highlight,
        billboard = billboard,
        distanceLabel = distanceLabel
    })
    
    print("‚úÖ ESP criado para " .. rarity .. " Lucky Block")
end

-- Fun√ß√£o para remover ESP de um bloco espec√≠fico
local function removeESP(part)
    local highlight = part:FindFirstChild("ESP_Highlight")
    local billboard = part:FindFirstChild("ESP_Distance")
    
    if highlight then
        highlight:Destroy()
    end
    
    if billboard then
        billboard:Destroy()
    end
    
    -- Remover da tabela de ESPs ativos
    for i, espData in ipairs(activeESPs) do
        if espData.part == part then
            table.remove(activeESPs, i)
            break
        end
    end
end

-- Fun√ß√£o para atualizar dist√¢ncias de TODOS os ESPs
local function updateDistances()
    if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then 
        return 
    end
    
    local playerPos = player.Character.HumanoidRootPart.Position
    
    for _, espData in ipairs(activeESPs) do
        if espData.part and espData.part.Parent and espData.distanceLabel then
            local distance = (espData.part.Position - playerPos).Magnitude
            espData.distanceLabel.Text = string.format("%.0fm", distance)
        end
    end
end

-- ========================================
-- FUN√á√ÉO PRINCIPAL DE SCAN E ATUALIZA√á√ÉO
-- ========================================

local function scanAndUpdateESP()
    -- Verificar cada raridade habilitada
    for rarity, enabled in pairs(_G.espRaridades) do
        if enabled then
            -- Procurar blocos dessa raridade no Workspace
            for _, part in pairs(Workspace:GetDescendants()) do
                if isCollectibleBlock(part) then
                    local detectedRarity = getRarity(part)
                    
                    -- Se a raridade do bloco corresponde e est√° habilitada
                    if detectedRarity == rarity then
                        -- Criar ESP se ainda n√£o existe
                        if not part:FindFirstChild("ESP_Highlight") then
                            createESP(part, rarity)
                        end
                    end
                end
            end
        else
            -- Se a raridade foi desabilitada, remover todos os ESPs dessa raridade
            for _, espData in ipairs(activeESPs) do
                if espData.rarity == rarity then
                    removeESP(espData.part)
                end
            end
        end
    end
    
    -- Atualizar dist√¢ncias
    updateDistances()
end

-- ========================================
-- FUN√á√ïES DE CONTROLE (Chamadas pela GUI)
-- ========================================

function _G.ativarESPLuckyBlockGitHub(raridade)
    print("‚úÖ GitHub: Ativando ESP para " .. raridade)
    _G.espRaridades[raridade] = true
    
    -- Iniciar loop se ainda n√£o estiver rodando
    if not espConnection then
        print("üîÑ GitHub: Iniciando loop de ESP...")
        espConnection = RunService.Heartbeat:Connect(function()
            scanAndUpdateESP()
        end)
    end
end

function _G.desativarESPLuckyBlockGitHub(raridade)
    print("‚èπÔ∏è GitHub: Desativando ESP para " .. raridade)
    _G.espRaridades[raridade] = false
    
    -- Remover todos os ESPs dessa raridade
    for i = #activeESPs, 1, -1 do
        local espData = activeESPs[i]
        if espData.rarity == raridade then
            removeESP(espData.part)
        end
    end
    
    -- Se nenhuma raridade est√° ativa, parar o loop
    local anyActive = false
    for _, enabled in pairs(_G.espRaridades) do
        if enabled then
            anyActive = true
            break
        end
    end
    
    if not anyActive and espConnection then
        print("‚èπÔ∏è GitHub: Parando loop de ESP (nenhuma raridade ativa)")
        espConnection:Disconnect()
        espConnection = nil
    end
end

-- ========================================
-- LIMPEZA AO REMOVER BLOCOS
-- ========================================

-- Detectar quando blocos s√£o removidos do Workspace
Workspace.DescendantRemoving:Connect(function(descendant)
    if descendant:IsA("BasePart") then
        removeESP(descendant)
    end
end)

-- ========================================
-- INICIALIZA√á√ÉO
-- ========================================

print("‚úÖ ESP Lucky Blocks carregado do GitHub!")
print("üì° Comunica√ß√£o com GUI estabelecida")
print("üéØ Pronto para detectar blocos individuais")
print("üåà Raridades suportadas:")
for rarity, color in pairs(rarityColors) do
    print("  - " .. rarity)
end
