-- ESP Lucky Blocks Script - VERS√ÉO CORRIGIDA v3.0
-- by ANXIIE
-- MOSTRA TODOS OS ESP ATIVADOS AO MESMO TEMPO
-- Estrutura: NaturalSpawnLuckyBlock_[Raridade]

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local player = Players.LocalPlayer

print("üîç ESP v3.0: Iniciando script corrigido...")

-- ========================================
-- CONFIGURA√á√ïES DE CORES POR RARIDADE
-- ========================================

local raridadeCores = {
    Celestial = Color3.fromRGB(255, 215, 0),     -- Dourado brilhante
    Legendary = Color3.fromRGB(255, 140, 0),     -- Laranja brilhante
    Secret = Color3.fromRGB(138, 43, 226),       -- Roxo
    Cosmic = Color3.fromRGB(147, 112, 219),      -- Roxo claro
    Mythical = Color3.fromRGB(255, 69, 0),       -- Vermelho alaranjado
    Epic = Color3.fromRGB(128, 0, 128),          -- Roxo escuro
    Rare = Color3.fromRGB(0, 112, 221),          -- Azul
    Uncommon = Color3.fromRGB(46, 125, 50),      -- Verde
    Common = Color3.fromRGB(158, 158, 158),      -- Cinza
    Divine = Color3.fromRGB(255, 255, 255)       -- Branco brilhante
}

-- Verificar se as vari√°veis globais existem
if not _G.espRaridades then
    _G.espRaridades = {
        Celestial = false,
        Legendary = false,
        Secret = false,
        Cosmic = false,
        Mythical = false,
        Epic = false,
        Rare = false,
        Uncommon = false,
        Common = false,
        Divine = false
    }
    print("‚ö†Ô∏è ESP: Vari√°veis globais criadas")
end

-- ========================================
-- FOLDER PARA ORGANIZAR ESP
-- ========================================

local folderESP = Instance.new("Folder")
folderESP.Name = "ESP_LuckyBlocks_ANXIIE"
folderESP.Parent = Workspace

-- ========================================
-- ARMAZENAMENTO DE ESP
-- ========================================

local todosESP = {} -- Tabela para armazenar TODOS os ESP ativos

-- ========================================
-- FUN√á√ÉO PARA DETECTAR RARIDADE DO BLOCO
-- ========================================

local function detectarRaridade(obj)
    if not obj then return nil end
    
    local nome = obj.Name
    local parentNome = obj.Parent and obj.Parent.Name or ""
    
    -- Verificar padr√£o: NaturalSpawnLuckyBlock_[Raridade]
    -- Buscar no nome do objeto
    for raridade, _ in pairs(raridadeCores) do
        if nome:find("_" .. raridade) or nome:find(raridade) then
            return raridade
        end
    end
    
    -- Buscar no nome do parent
    for raridade, _ in pairs(raridadeCores) do
        if parentNome:find("_" .. raridade) or parentNome:find(raridade) then
            return raridade
        end
    end
    
    return nil
end

-- ========================================
-- FUN√á√ÉO PARA CRIAR ESP VISUAL
-- ========================================

local function criarESP(target, raridade)
    if not target or not target:IsA("BasePart") then return nil end
    
    local char = player.Character
    if not char or not char:FindFirstChild("HumanoidRootPart") then
        return nil
    end
    
    -- Criar Highlight (melhor visualiza√ß√£o)
    local highlight = Instance.new("Highlight")
    highlight.Name = "ESP_Highlight_" .. raridade
    highlight.FillColor = raridadeCores[raridade]
    highlight.OutlineColor = raridadeCores[raridade]
    highlight.FillTransparency = 0.5
    highlight.OutlineTransparency = 0
    highlight.Adornee = target.Parent:IsA("Model") and target.Parent or target
    highlight.Parent = folderESP
    
    -- Criar BillboardGui para mostrar dist√¢ncia e nome
    local bill = Instance.new("BillboardGui")
    bill.Name = "ESP_Billboard_" .. raridade
    bill.Adornee = target
    bill.Size = UDim2.new(0, 150, 0, 60)
    bill.StudsOffset = Vector3.new(0, 3, 0)
    bill.AlwaysOnTop = true
    bill.Parent = folderESP
    
    local txt = Instance.new("TextLabel")
    txt.Size = UDim2.new(1, 0, 1, 0)
    txt.BackgroundTransparency = 1
    txt.TextColor3 = raridadeCores[raridade]
    txt.Font = Enum.Font.GothamBold
    txt.TextSize = 16
    txt.TextStrokeTransparency = 0.3
    txt.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    txt.Parent = bill
    
    -- Criar linha para o bloco
    local adorneeLine = char:FindFirstChild("HumanoidRootPart")
    
    local line = Instance.new("CylinderHandleAdornment")
    line.Name = "ESP_Line_" .. raridade
    line.AlwaysOnTop = true
    line.Color3 = raridadeCores[raridade]
    line.Radius = 0.2
    line.Transparency = 0.3
    line.Adornee = adorneeLine
    line.Parent = folderESP
    
    -- Conex√£o para atualizar posi√ß√£o e dist√¢ncia
    local renderConn
    renderConn = RunService.RenderStepped:Connect(function()
        if not _G.espRaridades[raridade] or not target or not target.Parent then
            -- Limpar ESP quando desativado ou bloco removido
            highlight:Destroy()
            bill:Destroy()
            line:Destroy()
            renderConn:Disconnect()
            
            -- Remover da lista
            for i, esp in ipairs(todosESP) do
                if esp.target == target then
                    table.remove(todosESP, i)
                    break
                end
            end
            return
        end
        
        if char and char:FindFirstChild("HumanoidRootPart") then
            local p1 = char.HumanoidRootPart.Position
            local p2 = target.Position
            local mag = (p2 - p1).Magnitude
            
            -- Atualizar linha
            line.Height = mag
            line.CFrame = CFrame.lookAt(p1, p2) * CFrame.new(0, 0, -mag/2)
            
            -- Atualizar texto
            txt.Text = string.format("üéÅ %s\nüìè %dm", raridade, math.floor(mag))
        end
    end)
    
    return {
        highlight = highlight,
        billboard = bill,
        line = line,
        connection = renderConn,
        target = target,
        raridade = raridade
    }
end

-- ========================================
-- FUN√á√ÉO PARA ENCONTRAR LUCKY BLOCKS
-- ========================================

local function encontrarLuckyBlocks()
    local blocks = {}
    
    -- Buscar em todo o Workspace
    for _, obj in pairs(Workspace:GetDescendants()) do
        if obj:IsA("BasePart") or obj:IsA("MeshPart") then
            local raridade = detectarRaridade(obj)
            
            if raridade then
                -- Verificar se j√° n√£o est√° na lista
                local jaExiste = false
                for _, espInfo in ipairs(todosESP) do
                    if espInfo.target == obj then
                        jaExiste = true
                        break
                    end
                end
                
                if not jaExiste then
                    table.insert(blocks, {block = obj, raridade = raridade})
                end
            end
        end
    end
    
    return blocks
end

-- ========================================
-- FUN√á√ÉO PARA ATUALIZAR TODOS OS ESP
-- ========================================

local function atualizarTodosESP()
    -- Encontrar novos blocos
    local novosBlocks = encontrarLuckyBlocks()
    
    -- Adicionar ESP para blocos que t√™m a raridade ativada
    for _, blockInfo in ipairs(novosBlocks) do
        local raridade = blockInfo.raridade
        
        if _G.espRaridades[raridade] then
            local esp = criarESP(blockInfo.block, raridade)
            if esp then
                table.insert(todosESP, esp)
                print("‚úÖ ESP adicionado:", raridade)
            end
        end
    end
end

-- ========================================
-- FUN√á√ÉO PARA LIMPAR ESP DE UMA RARIDADE
-- ========================================

local function limparESPRaridade(raridade)
    for i = #todosESP, 1, -1 do
        local esp = todosESP[i]
        if esp.raridade == raridade then
            if esp.highlight then esp.highlight:Destroy() end
            if esp.billboard then esp.billboard:Destroy() end
            if esp.line then esp.line:Destroy() end
            if esp.connection then esp.connection:Disconnect() end
            table.remove(todosESP, i)
        end
    end
    print("üóëÔ∏è ESP removido:", raridade)
end

-- ========================================
-- CONEX√ÉO COM A GUI
-- ========================================

function _G.ativarESPLuckyBlockGitHub(raridade)
    print("üéØ ESP GitHub: Ativando ESP para " .. raridade)
    _G.espRaridades[raridade] = true
    
    -- Atualizar ESP imediatamente
    atualizarTodosESP()
end

function _G.desativarESPLuckyBlockGitHub(raridade)
    print("‚èπÔ∏è ESP GitHub: Desativando ESP para " .. raridade)
    _G.espRaridades[raridade] = false
    
    -- Limpar ESP dessa raridade
    limparESPRaridade(raridade)
end

-- ========================================
-- MONITORAMENTO DE NOVOS BLOCOS
-- ========================================

-- Atualizar ESP a cada 3 segundos para novos blocos
spawn(function()
    while true do
        wait(3)
        atualizarTodosESP()
    end
end)

-- Monitorar novos objetos adicionados ao Workspace
Workspace.DescendantAdded:Connect(function(obj)
    wait(0.5) -- Aguardar objeto carregar
    
    if obj:IsA("BasePart") or obj:IsA("MeshPart") then
        local raridade = detectarRaridade(obj)
        
        if raridade and _G.espRaridades[raridade] then
            -- Verificar se j√° existe ESP para este objeto
            local jaExiste = false
            for _, esp in ipairs(todosESP) do
                if esp.target == obj then
                    jaExiste = true
                    break
                end
            end
            
            if not jaExiste then
                local esp = criarESP(obj, raridade)
                if esp then
                    table.insert(todosESP, esp)
                    print("üÜï Novo Lucky Block detectado:", raridade)
                end
            end
        end
    end
end)

-- ========================================
-- LIMPEZA AO MORRER E REINICIALIZA√á√ÉO
-- ========================================

player.CharacterAdded:Connect(function(character)
    -- Limpar todos os ESP
    for _, esp in ipairs(todosESP) do
        if esp.highlight then esp.highlight:Destroy() end
        if esp.billboard then esp.billboard:Destroy() end
        if esp.line then esp.line:Destroy() end
        if esp.connection then esp.connection:Disconnect() end
    end
    todosESP = {}
    
    -- Limpar folder
    folderESP:ClearAllChildren()
    
    -- Aguardar character carregar
    character:WaitForChild("HumanoidRootPart")
    wait(2)
    
    -- Recriar ESP dos blocos que estavam ativos
    atualizarTodosESP()
end)

-- ========================================
-- INICIALIZA√á√ÉO
-- ========================================

print("‚úÖ ESP Lucky Blocks v3.0 carregado!")
print("üéÆ Estrutura detectada: NaturalSpawnLuckyBlock_[Raridade]")
print("üìä Raridades suportadas: Celestial, Legendary, Secret, Cosmic, Mythical, Epic, Rare, Uncommon, Common, Divine")
print("üîç TODOS os ESP ativados aparecer√£o simultaneamente!")

-- Primeira varredura
wait(1)
atualizarTodosESP()
